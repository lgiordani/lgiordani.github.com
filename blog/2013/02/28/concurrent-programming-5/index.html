<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>"Concurrent programming - 5" - The Digital Cat</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="http://lgiordani.com/images/TheDigitalCat_favicon_32.png" rel="icon">

<link rel="canonical" href="http://lgiordani.com/blog/2013/02/28/concurrent-programming-5/">

        <meta name="author" content="Leonardo Giordani" />
        <meta name="keywords" content="C,operating systems,concurrent programming" />

    <!-- Enable latex plugin -->



    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@tw_lgiordani">
        <meta name="twitter:creator" content="@tw_lgiordani">
    <meta name="twitter:domain" content="http://lgiordani.com">
            <meta property="twitter:image"
                  content="http://lgiordani.com/images/TheDigitalCat_logo_200.jpg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://lgiordani.com/theme/css/bootstrap.spacelab.min.css" type="text/css"/>
    <link href="http://lgiordani.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://lgiordani.com/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="http://lgiordani.com/theme/css/style.css" type="text/css"/>

        <link href="http://lgiordani.com/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat ATOM Feed"/>


        <link href="http://lgiordani.com/category/programming/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat Programming ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://lgiordani.com/" class="navbar-brand">
<img src="http://lgiordani.com/images/TheDigitalCat_favicon_32.png" width="24"/> The Digital Cat            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://lgiordani.com/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="http://lgiordani.com/category/programming/">Programming</a>
                        </li>
                        <li >
                            <a href="http://lgiordani.com/category/projects/">Projects</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://lgiordani.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://lgiordani.com/blog/2013/02/28/concurrent-programming-5/"
                       rel="bookmark"
                       title="Permalink to "Concurrent programming - 5"">
                        "Concurrent programming - 5"
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-02-28T17:49:00+02:00"> gio 28 febbraio 2013</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://lgiordani.com/categories/c/">C</a>
        /
	<a href="http://lgiordani.com/categories/operating-systems/">operating systems</a>
        /
	<a href="http://lgiordani.com/categories/concurrent-programming/">concurrent programming</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Abstract</h2>
<p>In the past articles we introduced the concept of concurrent programming and studied a first solution to the problem of intercommunication: semaphores. As explained, the use of semaphores allows us to manage access to shared resources, and this is a first and very simple form of synchronization. In this issue, we will go one step further introducing a richer tool for concurrent programming: <em>message queues</em>.</p>
<h2>Limits of semaphores</h2>
<p>Ruling access to a resource through semaphores is a good form of synchronization, even if it is very limited. Indeed it prevents two or more processes simultaneously modifying shared data but does not allow them to exchange information.</p>
<p>Moreover, the basic use of semaphores does not guarantee the absence of dangerous situations. As an example remember that, in a multitasking environment, we do not know in advance which process will be executed and when. This means that a resource could be inaccessible for a process since it is always blocked by other processes.</p>
<p>Thus, while being a good tool in the multitasking programmer's bag, semaphores are not the final solution to his or her problems. So we now introduce a new tool which plays a big role in multitasking and distributed systems called <strong>message queues</strong>.</p>
<h2>Message queues theory</h2>
<p>Since message queues are one of the most important structures in computer science, let us dive into them at a slow pace. So first of all, what is a <strong>message</strong> in this context? Simply stated, a message is some <strong>data</strong> with a given <strong>format</strong>, which is a complex form to say everything. Indeed in the context of communication between processes, or computers, a message is a stream of bits which must be formatted according to a previously agreed format, where format means a set of rules the stream of bit must obey.</p>
<p>For example, we could simply state that a message is a raw extended <a href="http://en.wikipedia.org/wiki/ASCII">ASCII</a> string: this means that the stream must contain a multiple of 8 bits (since each extended ASCII character is represented by 8 bits). Our format is very simple, in this case, but it is enough to state that a message made of 377 bit is invalid. We can also make a message encompass entire files, and there is in general no limit to the size.</p>
<p>Now we have a definition of message. What is a <strong>queue</strong>? A queue is a list structure, where a given number of <em>homogeneous</em> objects can be stored. An object can be inserted in the list (<strong>push</strong>ed) and extracted from it (<strong>pop</strong>ped). Usually a queue in the messaging environment is a FIFO (First In First Out) one, meaning that the first object pushed is the first object popped. There is a plenty of mathematical and computer science theory about queues, buffers, FIFO, LIFO and other list types, and we will not review such topics here. Just a notice, to open further research by the reader: the stack, one of the most important concepts in programming, is also a memory buffer, or a queue, where the computer stores function calls and local variables.</p>
<p>So message queues are buffers where arbitrary (but homogeneous) objects called messages can be stored for a later retrieval.</p>
<p>Every process can create one or more queues and every process can send a message to one of them. The only prerequisite is that the unique identifier of the queue must be known. Since we are now working with processes spawned by a fork operation, each process can know the identifier of a queue if the queue has been created before executing <code>fork()</code>.</p>
<p>The knowledge of a queue identifier makes it is also possible to read messages from it. Messages can be accessed sequentially, reading the messages in chronological order (from the oldest, the first, to the most recent, the last arrived), but selectively, that is considering only the messages of a certain type: this last feature give us a sort of control on the priority of the messages we read.</p>
<p>Queues, therefore, can be used to implement several communication scenarios, from the simplest ones where all processes send messages to and read messages from the same queue, to more complex solutions such as a full mail system between processes.</p>
<p>Irrespective of the communication framework we set for our processes, synchronization can now be performed through a richer tool. Processes needing synchronization can exchange messages to establish the correct timings schedule when performing actions. Messages, thus, do not replace semaphores, but, as already seen, cover functionalities that they cannot provide.</p>
<p>Before we can switch to implement message queues in C language, it is necessary to speak about another problem related to messages: the need of a <em>communication protocol</em>.</p>
<h2>Creating a protocol</h2>
<p>A <strong>protocol</strong> is a set of rules which control the interaction of elements in a set. Every time you must regulate the exchange of information between two or more actors in a scenario you need a protocol, even when dealing with humans and not computers.</p>
<p>In <a href="/blog/2013/02/13/concurrent-programming-4">the past article</a> we implemented a very simple protocol when instructing processes to access a resource according to the status of a semaphore. This latter is also modified as part of the protocol itself.</p>
<p>As already stated in a past article, there is no difference between interprocess communication on the same machine or in a distributed environment (multiple machines): indeed, every network protocol (TCP/IP, DNS, SMTP, just to cite some of the most famous) is built on a message exchange architecture.</p>
<p>This is a simple example of a protocol based on message exchange: two processes, A and B, are executing concurrently and processing different data. Once they end the processing they have to merge their results. Here, synchronization problems arise: what process actually does the merging? If the process in charge of the merging operation is the process A, for example, the merging protocol can be described by these time charts, one for each process</p>
<h4>PROCESS B</h4>
<ol>
<li>Work with your data</li>
<li>When you finish send a message to A</li>
<li>When A answers, begin sending it your results</li>
</ol>
<h4>PROCESS A</h4>
<ol>
<li>Work with your data</li>
<li>Wait for a message from B</li>
<li>Answer the message</li>
<li>Receive data and merge them with yours</li>
</ol>
<p>Choosing the merger process is in this case totally arbitrary. This, however, can be a very important part of a protocol.</p>
<p>This protocol is extensible ina simple way to the case of n processes: every process but A works with its own data and then send a message to A. When A answers, the other process sends its results: the only process modified in this generalization is A since it has to receive messages from multiple processes instead of just one.</p>
<h2>System V Message Queues</h2>
<p>Now it is the time to speak about implementing these concepts in a Linux operating system environment. As already said we have a set of primitives that allow us to manage the structures related to message queues, and they are very similar to those dedicated to semaphore management, already described in <a href="/blog/2013/02/13/concurrent-programming-4">the past article</a>.</p>
<p>The structure used to describe a message is <code>msgbuf</code> and is declared in <code>linux/msg.h</code></p>
<div class="highlight"><pre><span class="cm">/* message buffer for msgsnd and msgrcv calls */</span>
<span class="k">struct</span> <span class="n">msgbuf</span> <span class="p">{</span>
   <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>         <span class="cm">/* type of message */</span>
   <span class="kt">char</span> <span class="n">mtext</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>      <span class="cm">/* message text */</span>
<span class="p">};</span>
</pre></div>


<p>The field <code>mtype</code> represents the type of the message and is a strictly positive number: the correspondence between numbers and message types has to be set in advance and is part of the protocol definition.</p>
<p>The second field represents the content of the message. With the standard definition, no real message can be held inside it because the space is too little (just one byte). This is just a placeholder since the real structure used to describe messages can be redefined in order to contain complex data. An example of redefinition is the following</p>
<div class="highlight"><pre><span class="k">struct</span> <span class="n">message</span> <span class="p">{</span>
   <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>         <span class="cm">/* message type */</span>
   <span class="kt">long</span> <span class="n">sender</span><span class="p">;</span>        <span class="cm">/* sender id */</span>
   <span class="kt">long</span> <span class="n">receiver</span><span class="p">;</span>        <span class="cm">/* receiver id */</span>        
   <span class="k">struct</span> <span class="n">info</span> <span class="n">data</span><span class="p">;</span>   <span class="cm">/* message content */</span>
<span class="p">};</span>
</pre></div>


<p>As you can see this is not a redefinition in the sense of object inheritance, being C a pure procedural language. The redefined structure must obey two simple rules: the first field must be a <code>long mtype</code> and the maximum size dimension shall be 8192 bytes.</p>
<p>This last limit is hard coded in the Linux kernel, i.e. there is a C <code>#define</code> directive in <code>linux/msg.h</code> which states</p>
<div class="highlight"><pre><span class="cp">#define MSGMAX  8192   </span><span class="cm">/* &lt;= INT_MAX */</span><span class="cp">   </span><span class="cm">/* max size of message (bytes) */</span><span class="cp"></span>
</pre></div>


<p>In the same file, there are other interesting limits such as <code>MSGMNB</code>, the maximum total size of a queue, which in Linux is set by default to 16384. That means that a queue containing 2 messages is already full.</p>
<p>A short notice about kernel parameters such as <code>MSGMAX</code>, <code>MSGMNB</code> and others: kernel parameters can obviously be changed by modifying the source code and recompiling the kernel, that is generating a custom Linux kernel. Varying some parameters, however, can be dangerous for the portability of your programs. Indeed, if you increase the maximum size of a message to, say, 16384 bytes, in order to host big messages, your application will crash on a kernel without that modification, where the maximum size is still 8192. Kernel parameters can also be changed at runtime through the <code>/proc</code> filesystem and the sysctl interface: these topics are very rich and important and thus deserve a larger space. For the time being, I let the reader research about them.</p>
<h4>Create a queue</h4>
<p>To create a new queue a process should call the <code>msgget()</code> function</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">msgget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</pre></div>


<p>which receives as arguments an IPC key (see <a href="/blog/2013/02/13/concurrent-programming-4">issue 4</a>) and some flags, which by now can be set to <code>IPC_CREAT | 0660</code> (create the queue if it does not exist
and grant access to the owner and group users). The returned integer is called queue identifier and is unique in the system.</p>
<h4>Send messages</h4>
<p>To send a message to a queue we call the <code>msgsnd()</code> primitive</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">msgsnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msgbuf</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</pre></div>


<p>where <code>msqid</code> is the identifier of the queue, <code>msgp</code> is a pointer to the message we have to send, <code>msgz</code> the size of the message in bytes (excluding the length of the <code>mtype</code> field, which is 4 bytes) and <code>msgflg</code> a flag related to the waiting policy.</p>
<p>Here, <code>msgp</code> is a pointer to a <code>struct msgbuf</code>. However, since that structure has been redefined, our actual call will contain a pointer to a variable of the redefined type.</p>
<p>The length of the message in bytes can be easily be found as</p>
<div class="highlight"><pre><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">message</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
</pre></div>


<p>where <code>struct message</code> is our redefinition of <code>struct msgbuf</code>.</p>
<p>Waiting policies are similar to those introduced for semaphores. This time the policy is used when the queue is full. If <code>msgflg</code> is set to <code>IPC_NOWAIT</code>, the sender process will not wait for some available space and will exit with an error code.</p>
<h4>Read messages</h4>
<p>To read messages contained in a queue we use the <code>msgrcv()</code> system call</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msgbuf</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">mtype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</pre></div>


<p>where the <code>msgp</code> pointer identifies the variable where we will copy the message read from the queue and mtype identifies the subset of messages we want to consider. As before, <code>msgp</code> should be a pointer to a variable of our redefined type and both <code>msgz</code> and <code>msgflg</code> have the same meaning of their counterparts in <code>msgsnd()</code>.</p>
<h4>Delete a queue</h4>
<p>Last, a queue can be removed calling the <code>msgctl()</code> primitive</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="nf">msgctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msqid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</pre></div>


<p>where the command <code>cmd</code> to remove the queue is <code>IPC_RMID</code>. Other two commands, <code>IPC_STAT</code> and <code>IPC_SET</code>, are available through <code>msgctl()</code>, but they are not interesting now.</p>
<h2>Putting it all together</h2>
<p>Let's test all these concepts with a simple program which creates a message queue, sends a message to it, reads the message and cancels the queue. After the message has been read, a comparison between the original values and the ones in the message is performed to check that the system is working.</p>
<div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;linux/ipc.h&gt;</span>
<span class="cp">#include &lt;linux/msg.h&gt;</span>

<span class="cm">/* Redefines the struct msgbuf */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">mymsgbuf</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">int_num</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">float_num</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span> <span class="kt">message_t</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">qid</span><span class="p">;</span>
  <span class="kt">key_t</span> <span class="n">msgkey</span><span class="p">;</span>

  <span class="kt">message_t</span> <span class="n">sent</span><span class="p">;</span>
  <span class="kt">message_t</span> <span class="n">received</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

  <span class="cm">/* Initialize the seed of the pseudo-random number generator */</span>
  <span class="n">srand</span> <span class="p">(</span><span class="n">time</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>

  <span class="cm">/* Length of the message */</span>
  <span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">message_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>

  <span class="n">msgkey</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

  <span class="cm">/* Create the queue*/</span>
  <span class="n">qid</span> <span class="o">=</span> <span class="n">msgget</span><span class="p">(</span><span class="n">msgkey</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0660</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;QID = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

  <span class="cm">/* Build a message */</span>
  <span class="n">sent</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">sent</span><span class="p">.</span><span class="n">int_num</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
  <span class="n">sent</span><span class="p">.</span><span class="n">float_num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">rand</span><span class="p">())</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
  <span class="n">sent</span><span class="p">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">rand</span><span class="p">())</span><span class="o">%</span><span class="mi">26</span> <span class="o">+</span> <span class="mi">97</span><span class="p">;</span>

  <span class="cm">/* Send the message */</span>
  <span class="n">msgsnd</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sent</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;MESSAGE SENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Receive the message */</span>
  <span class="n">msgrcv</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">received</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">sent</span><span class="p">.</span><span class="n">mtype</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;MESSAGE RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/* Control that received and sent messages are equal */</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Interger number = %d (sent %d) -- &quot;</span><span class="p">,</span> <span class="n">received</span><span class="p">.</span><span class="n">int_num</span><span class="p">,</span> <span class="n">sent</span><span class="p">.</span><span class="n">int_num</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">int_num</span> <span class="o">==</span> <span class="n">sent</span><span class="p">.</span><span class="n">int_num</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Float number = %f (sent %f) -- &quot;</span><span class="p">,</span> <span class="n">received</span><span class="p">.</span><span class="n">float_num</span><span class="p">,</span> <span class="n">sent</span><span class="p">.</span><span class="n">float_num</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">float_num</span> <span class="o">==</span> <span class="n">sent</span><span class="p">.</span><span class="n">float_num</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Char = &#39;%c&#39; (sent &#39;%c&#39;) -- &quot;</span><span class="p">,</span> <span class="n">received</span><span class="p">.</span><span class="n">ch</span><span class="p">,</span> <span class="n">sent</span><span class="p">.</span><span class="n">ch</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">ch</span> <span class="o">==</span> <span class="n">sent</span><span class="p">.</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Destroy the queue */</span>
  <span class="n">msgctl</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><a href="/code/queues1.c">source code</a></p>
<p>Now we can create two processes and let them communicate through a message queue. Remembering forking concepts explained in the <a href="/blog/2013/02/04/concurrent-programming-2">issue 2</a> you can recall that the child process, when created, receives a copy of the memory of its parent. This means that creating the queue before the fork operation results in both the parent and the child knowing the right queue identifier and thus capable of access it.</p>
<p>The following code creates a queue, then forks the execution. The child generates a random number, prints it on the standard output and sends them to the parent, which in turn prints it on the screen.</p>
<div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;linux/ipc.h&gt;</span>
<span class="cp">#include &lt;linux/msg.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>

<span class="cm">/* Redefines the message structure */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">mymsgbuf</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span> <span class="kt">message_t</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">qid</span><span class="p">;</span>
  <span class="kt">key_t</span> <span class="n">msgkey</span><span class="p">;</span>
  <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

  <span class="kt">message_t</span> <span class="n">buf</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">message_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>

  <span class="n">msgkey</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

  <span class="n">qid</span> <span class="o">=</span> <span class="n">msgget</span><span class="p">(</span><span class="n">msgkey</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0660</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;CHILD - Queue ID = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

    <span class="n">srand</span> <span class="p">(</span><span class="n">time</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="n">sleep</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
      <span class="n">buf</span><span class="p">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">buf</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">100</span><span class="p">;</span>
      <span class="n">msgsnd</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>      
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;CHILD - Sent message number %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PARENT - Queue ID = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">sleep</span> <span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">%</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">msgrcv</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PARENT - Received message number %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PARENT - Waiting for the child to terminate...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
  <span class="n">waitpid</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;PARENT - Child ended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="n">msgctl</span><span class="p">(</span><span class="n">qid</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><a href="queues2.c">source code</a></p>
<p>Compiling and running the program you can check the correct working of the shared message queue.</p>
<h2>Conclusions</h2>
<p>In this article, we introduced a new IPC structure called message queue and the related concepts of message and protocol. These concepts are very important and are going to be the foundation stone of a project we will realize step by step in the future articles: a simple telephone switch simulator.</p>
<h2>Previous article</h2>
<p><a href="/blog/2013/02/13/concurrent-programming-4">Concurrent Programming 4</a></p>
<h2>Next articles</h2>
<p><a href="/blog/2013/04/23/concurrent-programming-6">Concurrent Programming 6</a></p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="http://lgiordani.com/blog/2013/01/31/concurrent-programming-1/">"Concurrent programming - 1"</a></li>
        <li><a href="http://lgiordani.com/blog/2013/02/04/concurrent-programming-2/">"Concurrent programming - 2"</a></li>
        <li><a href="http://lgiordani.com/blog/2013/02/13/concurrent-programming-4/">"Concurrent programming - 4"</a></li>
        <li><a href="http://lgiordani.com/blog/2013/02/06/concurrent-programming-3/">"Concurrent programming - 3"</a></li>
        <li><a href="http://lgiordani.com/blog/2013/04/23/concurrent-programming-6/">"Concurrent programming - 6"</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">

                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                    <ul class="list-group" id="recentposts">
                        <li class="list-group-item">
                            <a href="http://lgiordani.com/blog/2014/10/14/decorators-and-metaclasses/">
                                "Advanced use of Python decorators and metaclasses"
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://lgiordani.com/blog/2014/09/04/python-3-oop-part-6-abstract-base-classes/">
                                "Python 3 OOP Part 6 - Abstract Base Classes"
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://lgiordani.com/blog/2014/09/01/python-3-oop-part-5-metaclasses/">
                                "Python 3 OOP Part 5 - Metaclasses"
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://lgiordani.com/blog/2014/08/21/python-3-oop-part-4-polymorphism/">
                                "Python 3 OOP Part 4 - Polymorphism"
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://lgiordani.com/blog/2014/08/20/python-3-oop-part-3-delegation-composition-and-inheritance/">
                                "Python 3 OOP Part 3 - Delegation: composition and inheritance"
                            </a>
                        </li>
                    </ul>
                </li>


                <li class="list-group-item"><a href="http://lgiordani.com/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group list-inline tagcloud" id="tags">
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/amqp/">
                                AMQP
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://lgiordani.com/categories/c/">
                                C
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://lgiordani.com/categories/concurrent-programming/">
                                concurrent programming
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/cpp/">
                                C++
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/decorators/">
                                decorators
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://lgiordani.com/categories/django/">
                                Django
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://lgiordani.com/categories/erlang/">
                                Erlang
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://lgiordani.com/categories/generators/">
                                generators
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/git/">
                                Git
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/metaclasses/">
                                metaclasses
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://lgiordani.com/categories/oop/">
                                OOP
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://lgiordani.com/categories/operating-systems/">
                                operating systems
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/pika/">
                                Pika
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/postage/">
                                Postage
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://lgiordani.com/categories/python/">
                                Python
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://lgiordani.com/categories/python2/">
                                Python2
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://lgiordani.com/categories/python3/">
                                Python3
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/qt/">
                                Qt
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://lgiordani.com/categories/rabbitmq/">
                                RabbitMQ
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://lgiordani.com/categories/versioning/">
                                versioning
                            </a>
                        </li>
                    </ul>
                </li>    

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Leonardo Giordani
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://lgiordani.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://lgiordani.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://lgiordani.com/theme/js/respond.min.js"></script>

    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-38715090-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->
</body>
</html>