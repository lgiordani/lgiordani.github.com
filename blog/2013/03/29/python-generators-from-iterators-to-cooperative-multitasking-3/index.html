<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Python Generators - From Iterators to Cooperative Multitasking - 3 - The Digital Cat</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="http://lgiordani.com/images/TheDigitalCat_favicon_32.png" rel="icon">

<link rel="canonical" href="http://lgiordani.com/blog/2013/03/29/python-generators-from-iterators-to-cooperative-multitasking-3/">

        <meta name="author" content="Leonardo Giordani" />
        <meta name="keywords" content="Python,generators" />

        <meta property="og:site_name" content="The Digital Cat" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Python Generators - From Iterators to Cooperative Multitasking - 3"/>
        <meta property="og:url" content="http://lgiordani.com/blog/2013/03/29/python-generators-from-iterators-to-cooperative-multitasking-3/"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2013-03-29" />
            <meta property="article:section" content="Programming" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="generators" />
            <meta property="article:author" content="Leonardo Giordani" />
            <meta property="og:image"
                  content="http://lgiordani.com/images/TheDigitalCat_logo_200.jpg"/>

    <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@tw_lgiordani">
        <meta name="twitter:creator" content="@tw_lgiordani">
    <meta name="twitter:domain" content="http://lgiordani.com">
            <meta property="twitter:image"
                  content="http://lgiordani.com/images/TheDigitalCat_logo_200.jpg"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://lgiordani.com/theme/css/bootstrap.spacelab.min.css" type="text/css"/>
    <link href="http://lgiordani.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://lgiordani.com/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="http://lgiordani.com/theme/css/style.css" type="text/css"/>

        <link href="http://lgiordani.com/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat ATOM Feed"/>



        <link href="http://lgiordani.com/category/programming/atom.xml" type="application/atom+xml" rel="alternate"
              title="The Digital Cat Programming ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://lgiordani.com/" class="navbar-brand">
<img src="http://lgiordani.com/images/TheDigitalCat_favicon_32.png" width="24"/> The Digital Cat            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://lgiordani.com/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="http://lgiordani.com/category/programming/">Programming</a>
                        </li>
                        <li >
                            <a href="http://lgiordani.com/category/projects/">Projects</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://lgiordani.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://lgiordani.com/blog/2013/03/29/python-generators-from-iterators-to-cooperative-multitasking-3/"
                       rel="bookmark"
                       title="Permalink to Python Generators - From Iterators to Cooperative Multitasking - 3">
                        Python Generators - From Iterators to Cooperative Multitasking - 3
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-03-29T13:25:00+01:00"> Fri 29 March 2013</time>
    </span>

            <span class="label label-default">Series</span>
            Part 3 of "Python generators - from iterators to cooperative multitasking"




<span class="label label-default">Tags</span>
	<a href="http://lgiordani.com/categories/python/">Python</a>
        /
	<a href="http://lgiordani.com/categories/generators/">generators</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Introduction</h2>
<p>In this third issue we move on uncovering how generators can be the foundation of a cooperative multitasking system and show some code that implements it. Before we face this topic we will talk shortly about another interesting use of generators, namely generator expressions chains.</p>
<h2>Chaining generator expressions</h2>
<p>At PyCon 2008 David M. Beazley, author of “Python Essential Reference”, made a very interesting speech about the use of generators in system administration, in other words where usually more or less complex bash scripts are involved and in particular where long pipe sequences are used.</p>
<p>David starts from the consideration that generators, producing one element at a time, are chainable, that is a generator expression can encompass another generator expression and so on. This way he shows how to write in a very compact and reusable way components that can act as “filters” on a data set, thus following the Unix philosophy of building tools that “do one thing and do it well”, chaining them afterwards to get the needed behaviour.</p>
<p>The slides of this presentation are freely downloadable, so I suggest the interested reader to take a look at it at the following address: <a href="http://www.dabeaz.com/generators-uk/">Generator Tricks for Systems Programmers</a>.</p>
<h2>Microthread: cooperative multitasking</h2>
<p><em>Disclaimer: the concepts and code presented here have been heavily influenced by the Kamaelia project. You can find it <a href="http://www.kamaelia.org">here</a>.</em></p>
<p>Let us move forward to see how (Python) generators allow us to easily build applications based on the concept of cooperative multitasking. I assume the reader is familiar with the concepts of preemption and thread-based multitasking and is aware of the pro and cons of such solutions.</p>
<p><strong>Cooperative multitasking</strong> allows an application to hold the control of the CPU for an arbitrary time lapse, waiting for it to voluntarily release the resource to the scheduler. This is a major break with the modern approach to multitasking, where the scheduler is in charge of stopping and resuming applications without any previous agreement with them.</p>
<p>Since application can now stop on their own initiative every issue related to shared data protection, atomicity and synchronization is greatly simplified if not removed. Applications need however a mechanism to stop running, save their internal state and later resume from the same point.</p>
<p>Generators, indeed, through the <code>yield</code> statement implement this very behaviour, thus they may be used to create a system based on cooperative multitasking, where processes are now called <strong>microthreads</strong> to highlight that they are a lightweight form of thread.</p>
<h4>Microthreads</h4>
<p>Let’s look at a simple implementation of such a system. First of all we need a <code>MicroThread</code> object, i.e. an object that can run simultaneously with other similar objects, but in a cooperative way.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MicroThread</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mi">1</span>
</pre></div>


<p>An instance of this object exposes a <code>main()</code> method that, when called, returns a generator. This latter, at each call of its <code>next()</code> method simply returns <code>1</code>, freezing at the same time its execution just after the <code>yield</code> statement, still inside the infinite while loop.</p>
<p>The object can be directly tested</p>
<div class="highlight"><pre>&gt;&gt;&gt; <span class="nv">mt</span> <span class="o">=</span> MicroThread<span class="o">()</span>
&gt;&gt;&gt; <span class="nv">g</span> <span class="o">=</span> mt.main<span class="o">()</span>
&gt;&gt;&gt; g
&lt;generator object main at 0xb74331e4&gt;
&gt;&gt;&gt; g.next<span class="o">()</span>
1
</pre></div>


<p>To make the object more easily inheritable and extendable we can refactor it a little</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MicroThread</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">yield</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">yield</span> <span class="mi">1</span>
</pre></div>


<p><a href="/code/python-generators/mthread.py">source code</a></p>
<p>Such changes let us inherit the class and extend it simply by overriding the <code>create()</code> and <code>step()</code> methods; the first is called as soon as <code>main()</code> is called, acting as a delayed initializer, while the second is executed at each call of <code>next()</code>, just before freezing the code with <code>yield</code>. Pay attention that since <code>create()</code> is called inside the generator function, you have to call <code>next()</code> once to run it after the genrator has been created. So the standard workflow with this object is</p>
<div class="highlight"><pre><span class="c"># Instance the object</span>
<span class="n">mt</span> <span class="o">=</span> <span class="n">MicroThread</span><span class="p">()</span>

<span class="c"># Create the generator</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

<span class="c"># Initialize it</span>
<span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<span class="c"># Loop over it</span>
<span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>


<p>Since <code>main()</code> is a generator function it must act as any generator and signal its exhaustion rising a <code>StopIteration</code> exception. The overridden <code>step()</code> method, thus, may raise this exception at any point (even multiple ones) to terminate the microthread.</p>
<h4>Scheduler</h4>
<p>Now we need a scheduler, i.e. the system component that manages running tasks. While in a true multitasking system the scheduler is a big and complex component, in a cooperative environment it can be rather simple: its job is to execute each task and wait till they give control back. In between a task and the following the scheduler can execute other functions, but its basic workflow is very straightforward. Obviously the scheduler shall handle the <code>StopIteration</code> exception possibly raised by a task, removing it from the list of running microthreads.</p>
<p>The core of the scheduler will be something like the following:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">active_microthreads</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">scheduled_microthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">active_microthreads</span> <span class="o">=</span> <span class="n">scheduled_microthreads</span>
<span class="n">scheduled_microthreads</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>


<p>This snippet encompasses the behaviour described above. We have two lists, <code>active_microthreads</code> with all the tasks that shall be executed in the current loop and <code>scheduled_microthreads</code> with all the tasks that are goig to be executed in the next loop. At each loop of the scheduler all microthreads in <code>active_microthreads</code> are executed, that is they are granted one execution of their <code>next()</code> function. After this the thread is scheduled again, i.e. it is appended to the <code>scheduled_microthreads</code> list. If the thread raises the <code>StopIteration</code> exception during its execution it is simply not scheduled again. When the <code>active_microthreads</code> list is exhausted the loop ends and the scheduled threads list is transferred in the <code>active_threads</code> one; after this the loop starts again.</p>
<p>So the first implementation of the scheduler is the following:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_microthread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mthread</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">mthread</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>


<p><a href="/code/python-generators/scheduler.py">source code</a></p>
<p>The <code>__init__()</code> method initializes the two internal lists we talked about above. The <code>add_microthread()</code> method allows us to add a microthread to the scheduler; the method calls <code>main()</code> on each microthread we add to obtain its generator, then calls <code>next()</code> once on this latter to initialize it and finally adds it to the list of scheduled tasks.</p>
<p>The scheduler logic is then implemented in the <code>run()</code> method, which executes the above core code in an infinite while loop.</p>
<p>We can test the microthreads and the scheduler with this simple code</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">mthread</span>
<span class="kn">import</span> <span class="nn">scheduler</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TestMicroThread</span><span class="p">(</span><span class="n">mthread</span><span class="o">.</span><span class="n">MicroThread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">number</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Number:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mt1</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mt2</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mt3</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ms</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Scheduler</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt1</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt2</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt3</span><span class="p">)</span>

<span class="n">ms</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p><a href="/code/python-generators/test_scheduler.py">source code</a></p>
<p>Here the <code>TestMicroThread</code> is a microthread but the <code>step()</code> method was reimplemented to print a number and wait 1 second. Three microthreads are instanced and added to the scheduler and the <code>run()</code> method of the scheduler is executed. Not surprisingly the result is the following</p>
<div class="highlight"><pre><span class="nv">$ </span>python test_scheduler.py
Number: 1
Number: 2
Number: 3
Number: 1
Number: 2
Number: 3
<span class="o">[</span>...<span class="o">]</span>
</pre></div>


<p>The three microthreads are executed in a round-robin fashion, as expected from a cooperative multitasking system.</p>
<p>Note: while all microthreads showed in this article just execute <code>yield 1</code> to freeze the code, <code>yield</code> can return any object, just like the <code>return</code> statement does, and this could be exploited to enhance the communication between microthreads and scheduler.</p>
<h4>Microschedulers</h4>
<p>The scheduler could however be more flexible, specifically it could be converted to a microthread itself. The scheduler, when executed, will return a generator, and each call of its <code>next()</code> method will run one of its microthreads. After this the scheduler will freeze and give control back.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MicroScheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_microthread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mthread</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">mthread</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">yield</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">active_microthreads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_microthreads</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>


<p><a href="/code/python-generators/mscheduler.py">source code</a></p>
<p>It is sufficient to rename <code>run()</code> to <code>main()</code>, to match our arbitrary microthread interface, and add some <code>yield</code> statements. The first <code>yield</code> at the beginning of <code>main()</code> terminates the creation part: this scheduler has no <code>create()</code> method, but if present it should be called here. The second <code>yield</code> is called if the scheduler contains no microthreads, since it has nothing to do. The third <code>yield</code> is called after each loop of the microthread running part.</p>
<p>These little changes allow the scheduler to be run into another scheduler, thus enabling us to create a hierarchy to easily build complex systems. At the same time the scheduler can be used as usual simply calling its <code>next()</code> method in a for loop.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">mthread</span>
<span class="kn">import</span> <span class="nn">mscheduler</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TestMicroThread</span><span class="p">(</span><span class="n">mthread</span><span class="o">.</span><span class="n">MicroThread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">number</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Number:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mt1</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mt2</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mt3</span> <span class="o">=</span> <span class="n">TestMicroThread</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ms</span> <span class="o">=</span> <span class="n">mscheduler</span><span class="o">.</span><span class="n">MicroScheduler</span><span class="p">()</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt1</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt2</span><span class="p">)</span>
<span class="n">ms</span><span class="o">.</span><span class="n">add_microthread</span><span class="p">(</span><span class="n">mt3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">main</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>


<p><a href="/code/python-generators/test_mscheduler.py">source code</a></p>
<p>This example is obviously very simple. However it shows how simple it is to build components of a cooperative system and let them live together in an execution space. Executing the scheduler in a different way, for example inside another generator, new microthreads can also be added live. This allows to instance system components on the fly to manage specific needs, such as incoming service requests.</p>
<h2>Conclusions</h2>
<p>Obviously this sort of multitasking cannot provide an interactive execution like that used on our desktop OS or on a Web server, where human users must receive an immediate feedback of their actions. But for systems where task must simply be simultaneously executed without timing needs cooperative multitasking is a valuable solution, due to its simplicity.</p>
<p>Another interesting scenario is that of a real multitasking system (ruled by threaded code or by the OS itself) where each task is made of small cooperating components. This way putting multiple functionalities inside a single component becomes a breeze; the code of each functionality could also be splitted in several plugins and loaded on demand.</p>
<p>A package that implements cooperative multitasking with generator based microthreads is <a href="http://www.kamaelia.org">Kamaelia</a>, and this article has been heavily inspired by it. Other solutions you can find interesting are <a href="http://pypi.python.org/pypi/greenlet">greenlet</a>, presently the most used microthread Python library that runs on the standard unmodified Python interpreter and <a href="http://www.stackless.com/">Stackless Python</a>, a fork of Python that natively implements microthreads.</p>
<h2>Updates</h2>
<p>2014-02-17: <a href="https://twitter.com/entropiae">Riccardo</a> spotted an error in the example code after <code>mthread.py</code> and submitted the correct version. Thanks!</p>
<h2>Past articles</h2>
<ul>
<li><a href="/blog/2013/03/25/python-generators-from-iterators-to-cooperative-multitasking">Python Generators - From Iterators to Cooperative Multitasking</a></li>
<li><a href="/blog/2013/03/26/python-generators-from-iterators-to-cooperative-multitasking-2">Python Generators - From Iterators to Cooperative Multitasking 2</a></li>
</ul>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="http://lgiordani.com/blog/2013/03/26/python-generators-from-iterators-to-cooperative-multitasking-2/">Python Generators - From Iterators to Cooperative Multitasking - 2</a></li>
        <li><a href="http://lgiordani.com/blog/2013/03/25/python-generators-from-iterators-to-cooperative-multitasking/">Python generators - from iterators to cooperative multitasking</a></li>
        <li><a href="http://lgiordani.com/blog/2014/05/19/method-overriding-in-python/">Method overriding in Python</a></li>
        <li><a href="http://lgiordani.com/blog/2014/09/01/python-3-oop-part-5-metaclasses/">Python 3 OOP Part 5 - Metaclasses</a></li>
        <li><a href="http://lgiordani.com/blog/2013/12/11/digging-up-django-class-based-views-2/">Digging up Django class-based views - 2</a></li>
    </ul>
</section>
<section class="well" id="related-posts">
    <h4>Part 3 of the "Python generators - from iterators to cooperative multitasking" series</h4>
       <h5>Previous articles</h5>
       <ul>
           <li><a href="http://lgiordani.com/blog/2013/03/25/python-generators-from-iterators-to-cooperative-multitasking/">Python generators - from iterators to cooperative multitasking</a></li>
           <li><a href="http://lgiordani.com/blog/2013/03/26/python-generators-from-iterators-to-cooperative-multitasking-2/">Python Generators - From Iterators to Cooperative Multitasking - 2</a></li>
       </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/tw_lgiordani"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="http://plus.google.com/+LeonardoGiordani?rel=author"><i class="fa fa-google-plus-square fa-lg"></i> Google+</a></li>
                <li class="list-group-item"><a href="https://github.com/lgiordani"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://lgiordani.com/blog/2015/06/22/using-gitflow-with-github-a-simple-procedure/">
                            Using gitflow with GitHub: a simple procedure
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://lgiordani.com/blog/2015/05/13/python-oop-tdd-example-part1/">
                            A simple example of Python OOP development (with TDD) - Part 1
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://lgiordani.com/blog/2015/05/13/99-scala-problems-16-20/">
                            99 Scala Problems 16-20
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://lgiordani.com/blog/2015/04/23/python-decorators-metaprogramming-with-style/">
                            Python decorators: metaprogramming with style
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://lgiordani.com/blog/2015/04/14/99-scala-problems-15-duplicate-the-elements-of-a-list-a-given-number-of-times/">
                            99 Scala Problems 15 - Duplicate the elements of a list a given number of times
                        </a>
                    </li>
                </ul>
            </li>


            <li class="list-group-item"><a href="http://lgiordani.com/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/amqp/">
                            AMQP
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/c/">
                            C
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/concurrent-programming/">
                            concurrent programming
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/cpp/">
                            C++
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://lgiordani.com/categories/decorators/">
                            decorators
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/django/">
                            Django
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://lgiordani.com/categories/erlang/">
                            Erlang
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://lgiordani.com/categories/functional-programming/">
                            functional programming
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/generators/">
                            generators
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://lgiordani.com/categories/git/">
                            Git
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/metaclasses/">
                            metaclasses
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/metaprogramming/">
                            metaprogramming
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/notebook/">
                            Notebook
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://lgiordani.com/categories/oop/">
                            OOP
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/operating-systems/">
                            operating systems
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/pika/">
                            Pika
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/postage/">
                            Postage
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://lgiordani.com/categories/python/">
                            Python
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://lgiordani.com/categories/python2/">
                            Python2
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://lgiordani.com/categories/python3/">
                            Python3
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/qt/">
                            Qt
                        </a>
                    </li>
                    <li class="list-group-item tag-3">
                        <a href="http://lgiordani.com/categories/rabbitmq/">
                            RabbitMQ
                        </a>
                    </li>
                    <li class="list-group-item tag-1">
                        <a href="http://lgiordani.com/categories/scala/">
                            Scala
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/tdd/">
                            TDD
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://lgiordani.com/categories/versioning/">
                            versioning
                        </a>
                    </li>
                </ul>
            </li>

                    <li class="list-group-item"><h4><i class="fa fa-tags fa-list-ul"></i><span class="icon-label">Series</span></h4>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <h5></i> Previous article</h5>
                                <a href="http://lgiordani.com/blog/2013/03/26/python-generators-from-iterators-to-cooperative-multitasking-2/">Python Generators - From Iterators to Cooperative Multitasking - 2</a>
                            </li>
                            <li class="list-group-item">
                            </li>
                        </ul>
                    </li>

    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Leonardo Giordani
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://lgiordani.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://lgiordani.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://lgiordani.com/theme/js/respond.min.js"></script>

    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-38715090-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552391e122c8506c"></script>
</body>
</html>